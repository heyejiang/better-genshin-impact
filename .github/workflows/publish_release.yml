name: BetterGI Publish
run-name: "BetterGI ${{ inputs.version }}"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'BetterGI Version (eg: 0.35.1, 0.36.5-alpha.1)'
        required: true
        type: string
      create-release:
        type: boolean
        description: 'åˆ›å»º GitHub Release'
        required: true
        default: true

jobs:
  # Add validation job to check version format
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Set version from input or tag
        id: set-version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Validate manual input version format
            if ! [[ "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
              echo "âŒ é”™è¯¯ï¼šç‰ˆæœ¬æ ¼å¼å¿…é¡»ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒ (ä¾‹å¦‚: 1.2.3, 1.2.3-alpha, 1.2.3+build.123)"
              exit 1
            fi
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "âœ¨ æ‰‹åŠ¨è§¦å‘æ„å»ºï¼Œç‰ˆæœ¬å·ï¼š${{ github.event.inputs.version }}"
          else
            # Extract version from tag name (remove 'v' prefix)
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "ğŸ·ï¸ ä» tag è§¦å‘æ„å»ºï¼Œç‰ˆæœ¬å·ï¼š${VERSION}"
          fi

  build_web_map_editor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: huiyadanli/bettergi-map
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm install
      - run: npm run build:single
      - uses: actions/upload-artifact@v4
        with:
          name: web_map_editor
          path: dist/

  build_web_scripts_list:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: zaodonganqi/bettergi-script-web
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - run: npm install
      - run: npm run build:single
      - uses: actions/upload-artifact@v4
        with:
          name: web_scripts_list
          path: dist/
  
  build_dist:
    runs-on: windows-latest
    needs: [validate, build_web_map_editor, build_web_scripts_list]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.x
      - name: æ›´æ–° csproj æ–‡ä»¶ç‰ˆæœ¬å·
        run: |
          $version = '${{ needs.validate.outputs.version }}'
          (Get-Content BetterGenshinImpact/BetterGenshinImpact.csproj) -replace '<Version>.*</Version>', "<Version>$version</Version>" | Set-Content BetterGenshinImpact/BetterGenshinImpact.csproj
      - name: è‡ªåŠ¨æäº¤æ›´æ”¹
        if: github.repository_owner == 'babalae'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update version to ${{ needs.validate.outputs.version }}"
          branch: main
          file_pattern: BetterGenshinImpact/BetterGenshinImpact.csproj
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/BetterGenshinImpact.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: ğŸ› ï¸ Build application
        run: dotnet publish BetterGenshinImpact/BetterGenshinImpact.csproj -c Release -p:PublishProfile=FolderProfile -p:Version=${{ needs.validate.outputs.version }}
        continue-on-error: true
      - name: ğŸ§¹ Clear & Move Files
        run: |
            $sourceDir = ".\BetterGenshinImpact\bin\x64\Release\net8.0-windows10.0.22621.0\publish\win-x64"
            Get-ChildItem -Path $sourceDir -Recurse -Filter "*.lib" | Remove-Item -Force
            Get-ChildItem -Path $sourceDir -Recurse -Filter "*ffmpeg*.dll" | Remove-Item -Force
            Get-ChildItem -Path $sourceDir -Recurse -Filter "*.pdb" | Remove-Item -Force
            New-Item -Path "dist/BetterGI" -ItemType Directory
            xcopy "$sourceDir\*" ".\dist\BetterGI\" /E /H /I /Y
      # ä¸‹è½½å‰é¢æ„å»ºå¥½çš„webå†…å®¹
      - uses: actions/download-artifact@v4
        with:
          name: web_map_editor
          path: dist/BetterGI/Assets/Map/Editor
      - uses: actions/download-artifact@v4
        with:
          name: web_scripts_list
          path: dist/BetterGI/Assets/Web/ScriptRepo
      # ä¸‹è½½æ„å»º repo çš„å†…å®¹è¡¥å……æ•°æ®
      - uses: actions/checkout@v4
        with:
          repository: babalae/bettergi-publish
          path: publish
      # æ‰“åŒ…ä¸Šä¼ 
      - name: ğŸ“¦ Generate archive
        run: |
          cd dist
          7z a "BetterGI_v${{  needs.validate.outputs.version }}.7z" BetterGI -t7z -mx=5 -mf=BCJ2 -r -y
      - uses: actions/upload-artifact@v4
        with:
          name: BetterGI_7z
          path: dist/BetterGI_*.7z

  # åˆ›å»º GitHub Releaseï¼ˆç›´æ¥å‘å¸ƒï¼Œéè‰ç¨¿ï¼‰
  create_release:
    if: github.event.inputs.create-release == 'true'
    needs: [validate, build_dist]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate.outputs.version }}
          name: BetterGI v${{ needs.validate.outputs.version }}
          body: |
            # BetterGI v${{ needs.validate.outputs.version }} å‘å¸ƒ
            
            ## ä¸‹è½½è¯´æ˜
            - è¯·ä¸‹è½½ `BetterGI_v${{ needs.validate.outputs.version }}.7z` æ–‡ä»¶
            - è§£å‹åè¿è¡Œ `BetterGI.exe` å³å¯
            
            ## æ›´æ–°æ—¥å¿—
            <!-- å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°æ—¥å¿— -->
            
            ## æ³¨æ„äº‹é¡¹
            - å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹[æ–‡æ¡£](https://github.com/babalae/better-genshin-impact/wiki)
            - æ¬¢è¿æäº¤ Issue å’Œåé¦ˆ
          draft: false  # æ”¹ä¸º falseï¼Œç›´æ¥å‘å¸ƒ
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          fail_on_unmatched_files: true
          files: |
            artifacts/BetterGI_7z/*.7z
